import React, { useState, useEffect, useRef } from 'react';
import { Plus, X, MapPin, CheckSquare, Clock, Search, Calendar, Instagram, ChevronRight, Wallet, Coffee, Utensils, ShoppingBag, Car, Bed, Sparkles, Send, MessageCircle, Loader2 } from 'lucide-react';

// --- Color Palette ---
const COLORS = {
  bg: '#FFFCF7',
  text: '#193046',
  greenDeep: '#2F6352',
  greenLeaf: '#5F8575',
  greenSoft: '#98B092',
  terra: '#E07D54',
  gold: '#FFE1A0',
  white: '#FFFFFF',
  red: '#FF6B6B',
};

// --- API Helper ---
const fetchGeminiResponse = async (prompt) => {
  const apiKey = ""; // Runtime provided key
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );
    if (!response.ok) throw new Error('API Error');
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return null;
  }
};

// --- Components ---

// 1. TIMELINE COMPONENT
const TimelineTab = () => {
  const [events, setEvents] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [inputText, setInputText] = useState('');
  const [deleteTarget, setDeleteTarget] = useState(null);

  useEffect(() => {
    const saved = localStorage.getItem('mokpo_timeline');
    if (saved) setEvents(JSON.parse(saved));
  }, []);

  const saveEvents = (newEvents) => {
    setEvents(newEvents);
    localStorage.setItem('mokpo_timeline', JSON.stringify(newEvents));
  };

  const handleAdd = () => {
    if (!inputText.trim()) return;
    const parts = inputText.split(/[\/|]/);
    let time = 'Time Unset';
    let content = inputText;
    
    if (parts.length >= 2) {
      time = parts[0].trim();
      content = parts[1].trim();
    }

    let emoji = 'ğŸ“Œ';
    let theme = 'nature';
    
    if (content.includes('ëª©í¬') || content.includes('ë²„ìŠ¤') || content.includes('ì¶œë°œ')) { emoji = 'ğŸšŒ'; theme = 'warm'; }
    else if (content.includes('ë°”ë‹¤')) { emoji = 'ğŸŒŠ'; theme = 'nature'; }
    else if (content.includes('ì‹ì‚¬') || content.includes('ë§›ì§‘')) { emoji = 'ğŸ±'; theme = 'warm'; }
    else if (content.includes('ì¹´í˜') || content.includes('ì»¤í”¼')) { emoji = 'â˜•'; theme = 'nature'; }
    else if (content.includes('ìˆ™ì†Œ') || content.includes('í˜¸í…”')) { emoji = 'ğŸ '; theme = 'nature'; }

    const newEvent = { id: Date.now(), time, content, emoji, theme };
    saveEvents([...events, newEvent]);
    setInputText('');
    setIsModalOpen(false);
  };

  const handleDelete = () => {
    if (deleteTarget) {
      saveEvents(events.filter(e => e.id !== deleteTarget));
      setDeleteTarget(null);
    }
  };

  const sortedEvents = [...events].sort((a, b) => a.time.localeCompare(b.time));

  return (
    <div className="h-full flex flex-col relative overflow-hidden bg-[#FFFCF7]">
      <h1 className="text-4xl font-black text-black mt-8 ml-6 z-10 tracking-tighter">TIMELINE</h1>
      
      <div className="flex-1 overflow-x-auto overflow-y-hidden flex items-center px-10 gap-8 pb-20 scrollbar-hide">
        <div className="flex-shrink-0 w-32 h-32 rounded-full border-4 border-white shadow-xl flex flex-col justify-center items-center text-center relative z-10"
             style={{ backgroundColor: COLORS.greenDeep }}>
          <span className="absolute -top-8 text-lg font-bold" style={{ color: COLORS.greenDeep }}>14:00</span>
          <span className="text-white font-bold text-lg mt-1">U-SQUARE</span>
          <span className="text-white text-xs font-light opacity-80">Start Point</span>
          <span className="absolute -bottom-8 text-xs font-bold tracking-widest" style={{ color: COLORS.greenLeaf }}>START</span>
        </div>

        {sortedEvents.map((evt) => (
          <div key={evt.id} 
               className="flex-shrink-0 relative group min-w-[160px] h-[100px] rounded-3xl flex flex-col justify-center items-center p-4 border-2 shadow-sm transition-all hover:scale-105"
               style={{ 
                 backgroundColor: evt.theme === 'warm' ? COLORS.terra : COLORS.greenLeaf,
                 borderColor: evt.theme === 'warm' ? COLORS.gold : COLORS.white,
                 color: 'white'
               }}>
            <button onClick={() => setDeleteTarget(evt.id)} 
                    className="absolute -top-3 -right-3 w-6 h-6 bg-red-500 rounded-full text-white flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity border-2 border-white shadow-md">
              <X size={14} />
            </button>
            <span className="text-xs font-bold mb-1 opacity-90" style={{ color: evt.theme === 'warm' ? COLORS.gold : '#E8F5E9' }}>{evt.time}</span>
            <span className="font-bold text-center flex items-center gap-1">{evt.emoji} {evt.content}</span>
          </div>
        ))}
        <div className="absolute top-1/2 left-0 w-full h-1 bg-gray-200 -z-0 transform translate-y-4" />
      </div>

      <button onClick={() => setIsModalOpen(true)}
              className="absolute bottom-6 right-6 w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-white text-3xl transition-transform hover:scale-110 hover:rotate-90 z-50"
              style={{ backgroundColor: COLORS.greenDeep }}>
        <Plus />
      </button>

      {isModalOpen && (
        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
            <h3 className="text-lg font-bold mb-4" style={{ color: COLORS.greenDeep }}>ì¼ì • ì¶”ê°€</h3>
            <div className="mb-4">
              <label className="block text-xs text-gray-500 mb-1">ì‹œê°„ / ë‚´ìš©</label>
              <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)}
                     placeholder="ì˜ˆ: 15:30 / ëª©í¬ì—­ ë„ì°©"
                     className="w-full p-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-[#2F6352]"
                     onKeyPress={(e) => e.key === 'Enter' && handleAdd()} />
            </div>
            <div className="flex justify-end gap-2">
              <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 bg-gray-100 rounded-lg text-gray-600 font-medium">ì·¨ì†Œ</button>
              <button onClick={handleAdd} className="px-4 py-2 text-white rounded-lg font-medium" style={{ backgroundColor: COLORS.greenDeep }}>ì¶”ê°€</button>
            </div>
          </div>
        </div>
      )}

      {deleteTarget && (
        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center">
            <p className="mb-6 font-bold text-gray-800">ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?</p>
            <div className="flex justify-center gap-3">
              <button onClick={() => setDeleteTarget(null)} className="px-4 py-2 bg-gray-100 rounded-lg text-gray-600">ì·¨ì†Œ</button>
              <button onClick={handleDelete} className="px-4 py-2 bg-red-500 text-white rounded-lg">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 2. CHECKLIST COMPONENT
const ChecklistTab = () => {
  const [tasks, setTasks] = useState([]);
  const [inputText, setInputText] = useState('');
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem('mokpo_checklist');
    if (saved) setTasks(JSON.parse(saved));
  }, []);

  const saveTasks = (newTasks) => {
    setTasks(newTasks);
    localStorage.setItem('mokpo_checklist', JSON.stringify(newTasks));
  };

  const addTask = (text) => {
    const val = text || inputText;
    if (!val.trim()) return;
    const newTask = { id: Date.now() + Math.random(), text: val.trim(), completed: false };
    saveTasks([...tasks, newTask]); // Use callback to ensure latest state if needed, but here simple spread is okay within sync flow
    if (!text) setInputText('');
  };

  const toggleTask = (id) => {
    saveTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
  };

  const handleDelete = () => {
    if (deleteTarget) {
      saveTasks(tasks.filter(t => t.id !== deleteTarget));
      setDeleteTarget(null);
    }
  };

  // --- GEMINI FEATURE: AI PACKING LIST ---
  const handleAiSuggest = async () => {
    setIsAiLoading(true);
    const prompt = "ëª©í¬ ì—¬í–‰ì— í•„ìš”í•œ í•„ìˆ˜ ì¤€ë¹„ë¬¼ 3ê°€ì§€ë§Œ ë‹¨ì–´ í˜•íƒœë¡œ ì¶”ì²œí•´ì¤˜. ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•´ì„œ ì•Œë ¤ì¤˜. (ì˜ˆ: ì„ ê¸€ë¼ìŠ¤, ì¹´ë©”ë¼, í¸í•œ ì‹ ë°œ)";
    const result = await fetchGeminiResponse(prompt);
    
    if (result) {
      const suggestions = result.split(',').map(s => s.trim());
      // Add items sequentially
      const newItems = suggestions.map((item, idx) => ({
        id: Date.now() + idx,
        text: item,
        completed: false
      }));
      // Merge with existing
      const updatedTasks = [...tasks, ...newItems];
      setTasks(updatedTasks);
      localStorage.setItem('mokpo_checklist', JSON.stringify(updatedTasks));
    }
    setIsAiLoading(false);
  };

  return (
    <div className="h-full flex flex-col relative overflow-hidden" style={{ backgroundColor: '#FFFCF7' }}>
      <div className="absolute inset-0 z-0 pointer-events-none opacity-60">
        <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full mix-blend-multiply filter blur-3xl animate-pulse" style={{ background: COLORS.greenSoft }}></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full mix-blend-multiply filter blur-3xl animate-pulse" style={{ background: COLORS.greenDeep, animationDelay: '2s' }}></div>
        <div className="absolute top-[30%] left-[30%] w-[40%] h-[40%] rounded-full mix-blend-multiply filter blur-3xl animate-pulse" style={{ background: COLORS.greenLeaf, animationDelay: '4s' }}></div>
      </div>

      <div className="relative z-10 flex flex-col h-full p-6">
        <div className="bg-white/80 backdrop-blur-xl rounded-[30px] shadow-xl border border-white/50 flex flex-col h-full overflow-hidden">
          <div className="p-6 pb-2 flex flex-col gap-3">
            <div className="flex gap-2">
                <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)}
                    placeholder="ì±™ê¸¸ ê²ƒ ì§ì ‘ ì…ë ¥"
                    className="flex-1 p-4 rounded-2xl border-none bg-white shadow-sm focus:ring-2 focus:ring-[#2F6352] outline-none text-gray-800 placeholder-gray-400"
                    onKeyPress={(e) => e.key === 'Enter' && addTask()} />
                <button onClick={() => addTask()} 
                        className="w-14 h-14 rounded-2xl flex items-center justify-center text-white text-2xl shadow-md hover:scale-105 transition-transform"
                        style={{ backgroundColor: COLORS.greenDeep }}>
                <Plus />
                </button>
            </div>
            
            {/* AI Suggestion Button */}
            <button 
                onClick={handleAiSuggest}
                disabled={isAiLoading}
                className="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold text-sm shadow-md flex items-center justify-center gap-2 hover:opacity-90 transition-opacity"
            >
                {isAiLoading ? <Loader2 className="animate-spin" size={16}/> : <Sparkles size={16}/>}
                {isAiLoading ? "AIê°€ ìƒê° ì¤‘..." : "AI ì¶”ì²œ ì¤€ë¹„ë¬¼ ìë™ ì¶”ê°€"}
            </button>
          </div>

          <div className="flex-1 overflow-y-auto px-6 pb-6 space-y-3">
            {tasks.length === 0 && (
              <div className="text-center text-gray-400 mt-10 text-sm">ì¤€ë¹„ë¬¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš” ğŸŒ¿</div>
            )}
            {tasks.map(task => (
              <div key={task.id} className="bg-white/90 p-4 rounded-2xl flex items-center gap-4 shadow-sm group hover:shadow-md transition-all border border-transparent hover:border-[#98B092]">
                <button onClick={() => toggleTask(task.id)}
                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-[#2F6352] border-[#2F6352]' : 'bg-white border-[#2F6352]'}`}>
                  {task.completed && <CheckSquare size={14} className="text-white" />}
                </button>
                <span className={`flex-1 font-medium ${task.completed ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{task.text}</span>
                <button onClick={() => setDeleteTarget(task.id)} className="text-gray-300 hover:text-[#E07D54] transition-colors">
                  <X size={20} />
                </button>
              </div>
            ))}
          </div>
        </div>
      </div>

      {deleteTarget && (
        <div className="absolute inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white p-6 rounded-2xl shadow-xl text-center border border-[#98B092]">
            <p className="mb-4 font-bold text-gray-800">ì •ë§ ì‚­ì œí• ê¹Œìš”? ğŸŒ¿</p>
            <div className="flex justify-center gap-2">
              <button onClick={() => setDeleteTarget(null)} className="px-4 py-2 bg-gray-100 rounded-xl text-gray-600">ì·¨ì†Œ</button>
              <button onClick={handleDelete} className="px-4 py-2 bg-[#2F6352] text-white rounded-xl shadow-md">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 3. BUDGET COMPONENT
const BudgetTab = () => {
  const [expenses, setExpenses] = useState([]);
  const [newItem, setNewItem] = useState({ desc: '', amount: '', cat: 'food' });
  const [isAdding, setIsAdding] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem('mokpo_budget');
    if (saved) setExpenses(JSON.parse(saved));
  }, []);

  const saveExpenses = (newExpenses) => {
    setExpenses(newExpenses);
    localStorage.setItem('mokpo_budget', JSON.stringify(newExpenses));
  };

  const addExpense = () => {
    if (!newItem.desc || !newItem.amount) return;
    const expense = {
      id: Date.now(),
      ...newItem,
      amount: parseInt(newItem.amount),
      date: new Date().toLocaleDateString()
    };
    saveExpenses([expense, ...expenses]);
    setNewItem({ desc: '', amount: '', cat: 'food' });
    setIsAdding(false);
  };

  const deleteExpense = (id) => {
    if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      saveExpenses(expenses.filter(e => e.id !== id));
    }
  };

  const totalSpent = expenses.reduce((acc, curr) => acc + curr.amount, 0);

  const categories = [
    { id: 'food', label: 'ì‹ë¹„', icon: <Utensils size={16}/> },
    { id: 'cafe', label: 'ì¹´í˜', icon: <Coffee size={16}/> },
    { id: 'transport', label: 'êµí†µ', icon: <Car size={16}/> },
    { id: 'shopping', label: 'ì‡¼í•‘', icon: <ShoppingBag size={16}/> },
    { id: 'stay', label: 'ìˆ™ë°•', icon: <Bed size={16}/> },
  ];

  return (
    <div className="h-full flex flex-col bg-[#FDFBF6] relative">
      <div className="p-6 bg-gradient-to-r from-[#2F6352] to-[#5F8575] text-white rounded-b-3xl shadow-lg mb-4">
        <h2 className="text-sm opacity-80 mb-1 font-medium">ì´ ì§€ì¶œ ê¸ˆì•¡</h2>
        <div className="flex items-baseline gap-1">
          <span className="text-4xl font-black tracking-tight">{totalSpent.toLocaleString()}</span>
          <span className="text-lg">ì›</span>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto px-6 pb-24">
        {!isAdding ? (
          <button onClick={() => setIsAdding(true)} 
                  className="w-full py-3 bg-white border-2 border-dashed border-[#2F6352]/30 text-[#2F6352] rounded-xl font-bold mb-4 hover:bg-[#2F6352]/5 transition-colors flex items-center justify-center gap-2">
            <Plus size={20} /> ì§€ì¶œ ë‚´ì—­ ì¶”ê°€
          </button>
        ) : (
          <div className="bg-white p-4 rounded-xl shadow-md border border-[#2F6352]/20 mb-4 animate-in fade-in slide-in-from-top-2">
            <div className="flex gap-2 mb-3 overflow-x-auto pb-2 scrollbar-hide">
              {categories.map(cat => (
                <button key={cat.id} 
                        onClick={() => setNewItem({...newItem, cat: cat.id})}
                        className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all ${newItem.cat === cat.id ? 'bg-[#2F6352] text-white' : 'bg-gray-100 text-gray-500'}`}>
                  {cat.icon} {cat.label}
                </button>
              ))}
            </div>
            <input type="text" placeholder="ë‚´ìš© (ì˜ˆ: ì ì‹¬ ë‚™ì§€íƒ•íƒ•ì´)" 
                   value={newItem.desc} onChange={(e) => setNewItem({...newItem, desc: e.target.value})}
                   className="w-full p-3 bg-gray-50 rounded-lg mb-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-[#2F6352]/20" />
            <input type="number" placeholder="ê¸ˆì•¡" 
                   value={newItem.amount} onChange={(e) => setNewItem({...newItem, amount: e.target.value})}
                   className="w-full p-3 bg-gray-50 rounded-lg mb-3 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-[#2F6352]/20" />
            <div className="flex gap-2">
              <button onClick={() => setIsAdding(false)} className="flex-1 py-2 bg-gray-100 rounded-lg text-gray-600 text-sm font-bold">ì·¨ì†Œ</button>
              <button onClick={addExpense} className="flex-1 py-2 bg-[#E07D54] text-white rounded-lg text-sm font-bold shadow-md">ì €ì¥</button>
            </div>
          </div>
        )}

        <div className="space-y-3">
          {expenses.length === 0 && !isAdding && (
            <div className="text-center text-gray-400 mt-10">ì§€ì¶œ ë‚´ì—­ì„ ê¸°ë¡í•´ë³´ì„¸ìš” ğŸ’¸</div>
          )}
          {expenses.map(item => (
            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-[#2F6352]/10 text-[#2F6352] flex items-center justify-center">
                  {categories.find(c => c.id === item.cat)?.icon || <Wallet size={18}/>}
                </div>
                <div>
                  <div className="font-bold text-gray-800">{item.desc}</div>
                  <div className="text-xs text-gray-400">{item.date} Â· {categories.find(c => c.id === item.cat)?.label}</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <span className="font-bold text-[#E07D54]">-{item.amount.toLocaleString()}</span>
                <button onClick={() => deleteExpense(item.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                  <X size={16} />
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// 4. AI GUIDE COMPONENT
const AITab = () => {
  const [messages, setMessages] = useState([
    { role: 'model', text: 'ì•ˆë…•í•˜ì„¸ìš”! ëª©í¬ ì—¬í–‰ AI ê°€ì´ë“œì…ë‹ˆë‹¤. ğŸŒ¿\në§›ì§‘ ì¶”ì²œ, ì½”ìŠ¤, ìˆ™ì†Œ ë“± ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!' }
  ]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const scrollRef = useRef(null);

  useEffect(() => {
    const saved = localStorage.getItem('mokpo_ai_chat');
    if (saved) setMessages(JSON.parse(saved));
  }, []);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
    localStorage.setItem('mokpo_ai_chat', JSON.stringify(messages));
  }, [messages]);

  const sendMessage = async () => {
    if (!input.trim()) return;
    
    const userMsg = { role: 'user', text: input };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsLoading(true);

    const result = await fetchGeminiResponse(input);
    const botText = result || "ì ì‹œ ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•Šì•„ìš”. ì¡°ê¸ˆ ë’¤ì— ë‹¤ì‹œ ë¬¼ì–´ë´ ì£¼ì„¸ìš”! ğŸ˜¥";
    setMessages(prev => [...prev, { role: 'model', text: botText }]);
    setIsLoading(false);
  };

  return (
    <div className="h-full flex flex-col bg-[#FDFBF6] relative">
      {/* Header */}
      <div className="p-5 bg-[#2F6352] text-white rounded-b-3xl shadow-md z-10">
        <h2 className="text-xl font-black flex items-center gap-2">
          <Sparkles size={20} className="text-[#FFE1A0]" /> ëª©í¬ ì—¬í–‰ AI
        </h2>
        <p className="text-xs text-emerald-100 opacity-80">Geminiê°€ ì—¬í–‰ ê³„íšì„ ë„ì™€ë“œë ¤ìš”</p>
      </div>

      {/* Chat Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-20" ref={scrollRef}>
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
             <div className={`max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap shadow-sm ${
               msg.role === 'user' 
                 ? 'bg-[#2F6352] text-white rounded-tr-none' 
                 : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none'
             }`}>
               {msg.text}
             </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
             <div className="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
               <div className="flex gap-1">
                 <div className="w-2 h-2 bg-[#2F6352] rounded-full animate-bounce"></div>
                 <div className="w-2 h-2 bg-[#2F6352] rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                 <div className="w-2 h-2 bg-[#2F6352] rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
               </div>
             </div>
          </div>
        )}
      </div>

      {/* Input Area */}
      <div className="p-4 bg-white border-t border-gray-100 absolute bottom-0 w-full">
        <div className="flex gap-2">
          <input 
            type="text" 
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
            placeholder="ëª©í¬ ë§›ì§‘ì´ë‚˜ ê°ˆë§Œí•œ ê³³ ì¶”ì²œí•´ì¤˜!" 
            className="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-200 focus:bg-white focus:border-[#2F6352] outline-none text-sm"
          />
          <button 
            onClick={sendMessage}
            disabled={isLoading}
            className="p-3 bg-[#2F6352] text-white rounded-xl disabled:opacity-50 hover:bg-[#244e40] transition-colors">
            <Send size={20} />
          </button>
        </div>
      </div>
    </div>
  );
};


// --- MAIN APP ---
const App = () => {
  const [activeTab, setActiveTab] = useState('timeline'); 

  return (
    <div className="w-full h-screen bg-gray-100 flex justify-center overflow-hidden font-sans">
      <div className="w-full max-w-md h-full bg-white shadow-2xl overflow-hidden flex flex-col relative">
        
        {/* Main Content Area */}
        <div className="flex-1 overflow-hidden relative pb-20">
          {activeTab === 'timeline' && <TimelineTab />}
          {activeTab === 'checklist' && <ChecklistTab />}
          {activeTab === 'budget' && <BudgetTab />}
          {activeTab === 'ai' && <AITab />}
        </div>

        {/* Bottom Navigation */}
        <div className="h-20 bg-white border-t border-gray-100 flex justify-around items-center px-1 pb-2 z-50 absolute bottom-0 w-full">
          <button onClick={() => setActiveTab('timeline')} 
                  className={`flex flex-col items-center gap-1 p-1 rounded-xl transition-all w-1/4 ${activeTab === 'timeline' ? 'text-[#2F6352]' : 'text-gray-300'}`}>
            <div className={`p-1.5 rounded-full ${activeTab === 'timeline' ? 'bg-[#2F6352]/10' : ''}`}>
              <Calendar size={20} strokeWidth={activeTab === 'timeline' ? 2.5 : 2} />
            </div>
            <span className="text-[9px] font-bold">ì¼ì •</span>
          </button>

          <button onClick={() => setActiveTab('checklist')} 
                  className={`flex flex-col items-center gap-1 p-1 rounded-xl transition-all w-1/4 ${activeTab === 'checklist' ? 'text-[#2F6352]' : 'text-gray-300'}`}>
            <div className={`p-1.5 rounded-full ${activeTab === 'checklist' ? 'bg-[#2F6352]/10' : ''}`}>
              <CheckSquare size={20} strokeWidth={activeTab === 'checklist' ? 2.5 : 2} />
            </div>
            <span className="text-[9px] font-bold">ì¤€ë¹„ë¬¼</span>
          </button>

          <button onClick={() => setActiveTab('budget')} 
                  className={`flex flex-col items-center gap-1 p-1 rounded-xl transition-all w-1/4 ${activeTab === 'budget' ? 'text-[#2F6352]' : 'text-gray-300'}`}>
            <div className={`p-1.5 rounded-full ${activeTab === 'budget' ? 'bg-[#2F6352]/10' : ''}`}>
              <Wallet size={20} strokeWidth={activeTab === 'budget' ? 2.5 : 2} />
            </div>
            <span className="text-[9px] font-bold">ê°€ê³„ë¶€</span>
          </button>

          <button onClick={() => setActiveTab('ai')} 
                  className={`flex flex-col items-center gap-1 p-1 rounded-xl transition-all w-1/4 ${activeTab === 'ai' ? 'text-[#2F6352]' : 'text-gray-300'}`}>
            <div className={`p-1.5 rounded-full ${activeTab === 'ai' ? 'bg-[#2F6352]/10' : ''}`}>
              <Sparkles size={20} strokeWidth={activeTab === 'ai' ? 2.5 : 2} />
            </div>
            <span className="text-[9px] font-bold">AIê°€ì´ë“œ</span>
          </button>
        </div>
      </div>
    </div>
  );
};

export default App;
